name: ci

on:
  push:
    # run CI on all branches so feature/topic branches trigger actions
    branches: ['**']
  pull_request:
    branches: ['**']

jobs:
  build-and-test-linux:
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: Install System Dependencies
      run: |
        sudo apt-get update -qq
        sudo apt-get install -y --no-install-recommends cmake libtbb-dev libopenblas-dev liblapacke-dev
        echo "LAPACKE_INCLUDE_DIR=/usr/include" >> $GITHUB_ENV

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -q numpy scipy scikit-build qiskit qiskit-aer pytest
        python -m pip install -e . -q

    - name: Build
      env:
        TBB_LIB_DIR: /usr/lib/x86_64-linux-gnu
        TBB_INC_DIR: /usr/include
        LAPACKE_INCLUDE_DIR: /usr/include
      run: |
        python setup.py build_ext -q

    - name: Test
      env:
        OMP_NUM_THREADS: 1
        OPENBLAS_NUM_THREADS: 1
        MKL_NUM_THREADS: 1
        VECLIB_MAXIMUM_THREADS: 1
        NUMEXPR_NUM_THREADS: 1
        PYTHONWARNINGS: default
      run: |
        pytest tests/ -x -v --tb=line

  build-and-test-windows:
    runs-on: windows-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Miniconda
      uses: conda-incubator/setup-miniconda@v3
      with:
        auto-update-conda: true
        python-version: '3.13'
        channels: conda-forge

    - name: Install Windows System Dependencies
      shell: pwsh
      run: |
        conda install -c conda-forge cmake tbb-devel openblas lapack -y
        # Get active conda environment
        $envPath = conda env list | Select-String '\*' | ForEach-Object { ($_ -split '\s+', 3)[1] }
        if (-not $envPath) {
          $envPath = conda info --base
        }
        # Convert to forward slashes for GITHUB_ENV (CMake accepts both)
        $envPath = $envPath.Replace('\', '/')
        $tbbLib = "$envPath/Library/lib"
        $tbbInc = "$envPath/Library/include"
        
        # Verify TBB installation
        Write-Host "Checking TBB installation..."
        Write-Host "Environment path: $envPath"
        Write-Host "TBB include path: $tbbInc"
        Write-Host "TBB lib path: $tbbLib"
        if (Test-Path "$tbbInc/tbb/tbb.h") {
          Write-Host "TBB header found at: $tbbInc/tbb/tbb.h"
        } else {
          Write-Host "WARNING: TBB header not found at: $tbbInc/tbb/tbb.h"
          # Try to find it
          $foundTbb = Get-ChildItem -Path "$envPath" -Recurse -Filter "tbb.h" -ErrorAction SilentlyContinue | Select-Object -First 1
          if ($foundTbb) {
            $actualTbbInc = $foundTbb.DirectoryName.Replace('\', '/')
            Write-Host "Found TBB header at: $actualTbbInc"
            $tbbInc = $actualTbbInc
          }
        }
        # Write to GITHUB_ENV using Out-File
        "TBB_LIB_DIR=$tbbLib" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        "TBB_INC_DIR=$tbbInc" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        "BLAS_LIB_DIR=$tbbLib" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8
        "CONDA_PREFIX=$envPath" | Out-File -FilePath $env:GITHUB_ENV -Append -Encoding utf8

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -q numpy scipy scikit-build qiskit qiskit-aer pytest
        python -m pip install -e . -q

    - name: Build
      env:
        TBB_LIB_DIR: ${{ env.TBB_LIB_DIR }}
        TBB_INC_DIR: ${{ env.TBB_INC_DIR }}
      run: |
        python setup.py build_ext -q


  build-and-test-macos:
    runs-on: macos-latest
    timeout-minutes: 60

    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'
    
    - name: Install macOS System Dependencies
      run: |
        brew install cmake tbb openblas lapack libomp

    - name: Set environment variables (macOS)
      run: |
        echo "TBB_LIB_DIR=$(brew --prefix tbb)/lib" >> $GITHUB_ENV
        echo "TBB_INC_DIR=$(brew --prefix tbb)/include" >> $GITHUB_ENV
        echo "OMP_NUM_THREADS=1" >> $GITHUB_ENV
        # Help CMake find OpenMP on macOS
        export OMP_PREFIX=$(brew --prefix libomp)
        echo "OpenMP_C_FLAGS=-Xpreprocessor -fopenmp -I$OMP_PREFIX/include" >> $GITHUB_ENV
        echo "OpenMP_CXX_FLAGS=-Xpreprocessor -fopenmp -I$OMP_PREFIX/include" >> $GITHUB_ENV
        echo "OpenMP_C_LIB_NAMES=omp" >> $GITHUB_ENV
        echo "OpenMP_CXX_LIB_NAMES=omp" >> $GITHUB_ENV
        echo "OpenMP_omp_LIBRARY=$OMP_PREFIX/lib/libomp.dylib" >> $GITHUB_ENV

    - name: Install Python Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -q numpy scipy scikit-build qiskit qiskit-aer pytest
        python -m pip install -e . -q

    - name: Build
      env:
        TBB_LIB_DIR: ${{ env.TBB_LIB_DIR }}
        TBB_INC_DIR: ${{ env.TBB_INC_DIR }}
      run: |
        python setup.py build_ext -q

    - name: Test
      env:
        OMP_NUM_THREADS: 1
        OPENBLAS_NUM_THREADS: 1
        MKL_NUM_THREADS: 1
        VECLIB_MAXIMUM_THREADS: 1
        NUMEXPR_NUM_THREADS: 1
        PYTHONWARNINGS: default
      run: |
        pytest tests/ -x -v --tb=line
